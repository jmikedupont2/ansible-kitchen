---

- set_fact:
    kitchen_deps:
      - ruby2.0
      - ruby2.0-dev
    kitchen_gem: /usr/bin/gem2.0
  when: ansible_distribution_release == 'trusty'
- set_fact:
    kitchen_deps:
      - ruby2.3
      - ruby2.3-dev
    kitchen_gem: /usr/bin/gem2.3
  when: ansible_distribution_release == 'xenial'

- name: apt | kitchen dependencies
  apt: name={{item}} state=present
  with_items: "{{ kitchen_deps }}"

## FIXME! whatever settings, installed in /home/vagrant/.gem/ruby/2.0.0/bin/kitchen or /root/.gem ...
## FIXME! not idempotent
- block:
    - name: install kitchen modules with gem - user
      gem: name={{ item }} state=latest executable={{ kitchen_gem }}
      with_items: "{{ kitchen_gemlist }}"
      become: yes
      become: "{{ kitchen_user }}"
    - name: check ruby spec permissions
      file: "dest={{ item }} state=directory mode=0755 owner={{ kitchen_user }}"
      with_items:
        - "/home/{{ kitchen_user }}/.gem"
  when: kitchen_user is defined and kitchen_user != "" and kitchen_user != 'root'

- block:
    - name: install kitchen modules with gem - global
      gem: name={{ item }} state=latest executable={{ kitchen_gem }} user_install=no
      with_items: "{{ kitchen_gemlist }}"
        - "/home/{{ kitchen_user }}/.gem/specs"
   - name: check ruby spec permissions - root
      file: "dest={{ item }} state=directory mode=0711 owner=root"
      with_items:
        - "/root"
        - "/root/.gem"
        - "/root/.gem/specs"
  when: kitchen_user is not defined or kitchen_user == "" or kitchen_user == 'root' 

